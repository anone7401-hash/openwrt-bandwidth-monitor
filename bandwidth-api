#!/bin/sh

# 

# OpenWrt Bandwidth Monitor - Backend API

# File: /www/cgi-bin/bandwidth-api

# Created by: PakRT

# Version: 1.0.0

# 

# Set HTTP headers

echo “Content-Type: application/json”
echo “Access-Control-Allow-Origin: *”
echo “”

# Main function

get_bandwidth_data() {
echo ‘{“users”:[’

```
first=true

# Check if DHCP leases file exists
if [ ! -f /tmp/dhcp.leases ]; then
    echo '],"error":"DHCP leases file not found"}'
    return
fi

# Read DHCP leases and generate device info
while read -r timestamp mac ip hostname extra; do
    # Skip empty lines
    [ -z "$mac" ] && continue
    
    # Skip duid entries (IPv6)
    [ "$mac" = "duid" ] && continue
    
    # Validate MAC address format (must contain colon)
    echo "$mac" | grep -q ":" || continue
    
    # Set default hostname if empty or wildcard
    if [ -z "$hostname" ] || [ "$hostname" = "*" ]; then
        hostname="Device-${ip##*.}"
    fi
    
    # Clean hostname (remove special characters)
    hostname=$(echo "$hostname" | sed 's/[^a-zA-Z0-9._-]/-/g')
    
    # Check if device is currently connected (ping test)
    connected="false"
    if ping -c 1 -W 1 "$ip" >/dev/null 2>&1; then
        connected="true"
    fi
    
    # Generate bandwidth data
    # Note: This is simulated data. For real data, integrate with iptables or nlbwmon
    if [ "$connected" = "true" ]; then
        # Online devices: higher bandwidth
        download=$((RANDOM * 50000 + 5000000))
        upload=$((RANDOM * 20000 + 1000000))
    else
        # Offline devices: lower bandwidth (historical data)
        download=$((RANDOM * 10000 + 100000))
        upload=$((RANDOM * 5000 + 50000))
    fi
    
    # Calculate total
    total=$((download + upload))
    
    # Generate signal strength (60-100%)
    signal=$((RANDOM % 40 + 60))
    
    # Generate random connection duration (10-330 minutes)
    duration=$((RANDOM % 300 + 30))
    
    # Add comma separator if not first item
    if [ "$first" = "false" ]; then
        echo ","
    fi
    first=false
    
    # Output JSON object for this device
    cat <<JSON
```

{
“id”: “$mac”,
“name”: “$hostname”,
“ip”: “$ip”,
“mac”: “$mac”,
“download”: $download,
“upload”: $upload,
“total”: $total,
“connected”: $connected,
“signal”: $signal,
“duration”: $duration
}
JSON

```
done < /tmp/dhcp.leases

echo ']}'
```

}

# Execute main function

get_bandwidth_data